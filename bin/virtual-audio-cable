#! /usr/bin/python3
#
# Create a virtual audio cable to connect the output of OBS
# to the microphone input of Zoom.
#

import sys, os, types, re
from subprocess import run, PIPE
from time import sleep

def get_obj_id(name):
	output = run(["pw-cli", "ls", name], stdout=PIPE, check=True).stdout
	m = re.match(r"\s+id (\d+)", output.decode("UTF-8"))
	if m:
		return int(m.group(1))	
	else:
		return None

def destroy_obj(id):
	run(["pw-cli", "destroy", str(id)], check=True)

def list_ports(direction):
	output = run(["pw-link", "-" + direction], stdout=PIPE, check=True).stdout
	return output.decode("UTF-8").split("\n")

def list_links():
	output = run(["pw-link", "-l"], stdout=PIPE, check=True).stdout.decode("UTF-8")
	# To-Zoom:monitor_MONO
	#   |-> From-OBS:input_MONO
	#   |-> alsa_output.pci-0000_00_14.2.analog-stereo:playback_FL
	#   |-> alsa_output.pci-0000_00_14.2.analog-stereo:playback_FR
	links = []
	left = None
	for line in output.split("\n"):
		m = re.match(r"^  \|-> (.+)$", line)
		if m:
			links.append((left, m.group(1)))
		else:
			left = line.strip()
	#print("links:", links)
	return links

def create_null_sink(name, media_class):
	run(["pactl",
		"load-module", "module-null-sink",
		"media.class=" + media_class,
		"sink_name=" + name,
		"sink_properties=device.description=" + name,
		"channel_map=mono",
		], stdout=PIPE, check=True)

def create_link(node1, node2):
	print("Linking %s to %s..." % (node1, node2))
	if (node1, node2) in list_links():
		print("  Link already exists.")
	else:
		run(["pw-link", node1, node2], check=True)
		print("  Link created.")

def create_cable():
	print("Creating To-Zoom...")
	if "To-Zoom:playback_MONO" in list_ports("i"):
		print("  To-Zoom already exists.")
	else:
		create_null_sink("To-Zoom", "Audio/Sink")
		print("  Created.")
	
	print("Creating From-OBS...")
	if "From-OBS:capture_MONO" in list_ports("o"):
		print("  From-OBS already exists.")
	else:
		create_null_sink("From-OBS", "Audio/Source/Virtual")
		print("  Created.")
	
	# Give them a chance to settle
	sleep(.1)
	
	# Connect them
	create_link("To-Zoom:monitor_MONO", "From-OBS:input_MONO")

def destroy_cable():
	for name in ("From-OBS", "To-Zoom"):
		id = get_obj_id(name)
		if id is not None:
			destroy_obj(id)

def connect_peripherals():
	# Load the Flask configuration file
	config = types.ModuleType("config")
	config.__file__ = os.path.join(os.path.dirname(__file__), "..", "instance", "config.py")
	with open(config.__file__, mode="rb") as config_file:
		exec(compile(config_file.read(), config.__file__, "exec"), config.__dict__)
	
	# Connect the microphone specified in config.py to the input of the virtual
	# audio cable which connects the output of OBS to the micriphone input of Zoom.
	if "microphone" in config.PERIPHERALS:
		create_link(config.PERIPHERALS["microphone"], "From-OBS:input_MONO")
	
	# Connect each set of speakers specified in config.py to the output of the
	# same virtual audio cable. This allows those physically present to hear
	# what OBS is sending to Zoom.
	if "speakers" in config.PERIPHERALS:
		for port in ("playback_FL", "playback_FR"):
			create_link("To-Zoom:monitor_MONO", config.PERIPHERALS["speakers"] + ":" + port)

good = 0
for arg in sys.argv[1:]:
	match arg:
		case "create":
			create_cable()
			good += 1
		case "destroy":
			destroy_cable()
			good += 1
		case "connect-peripherals":
			connect_peripherals()
			good += 1
		case "list-links":
			print("\n".join(map(lambda link: link[0] + " " + link[1], list_links())))
			good += 1
		case _:
			good = False
			break
if not good:
	sys.stderr.write("Usage: virtual-audio-cable [create, destroy, connect-peripherals]\n")
	sys.exit(1)

