#! /usr/bin/env python3
# obs2zoom

import os, sys
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "lib"))
import argparse
import logging

# Modules have the logging level set to INFO except when we are debugging
# them. Let the DEBUG messages through here.
logging.basicConfig(
	level=logging.DEBUG,
	format='%(asctime)s %(levelname)s %(message)s',
	datefmt='%Y-%m-%d %H:%M:%S'
	)

with open("/proc/modules") as modules:
	for line in modules:
		if line.startswith("v4l2loopback "):
			break
	else:
		sys.stderr.write("Module v4l2loopback is not loaded.\n")
		sys.exit(1)

from obs_ws import ObsEventReader
from obs2zoom_policies import ObsToZoomManual, ObsToZoomAuto
from zoom import ZoomControl

parser = argparse.ArgumentParser(description="Automatically stop and start sharing of OBS virtual camera in Zoom")
parser.add_argument("--auto", dest="auto_mode", action="store_true", help="share screen when vcam on and media playing")
parser.add_argument("--manual", dest="auto_mode", action="store_false", help="share screen when vcam on")
options = parser.parse_args()

try:
	obs = ObsEventReader()
except ConnectionRefusedError:
	sys.stderr.write("%s: OBS-Websocket not running\n" % sys.argv[0])
	sys.exit(1)

zoom = ZoomControl()

if options.auto_mode:
	policy = ObsToZoomAuto(obs, zoom)
else:
	policy = ObsToZoomManual(obs, zoom)

while policy.handle_message():
	pass

